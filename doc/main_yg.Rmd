---
title: "R Notebook"
author: Yue Gao
output: html_notebook
---

This notebook is for Data Cleaning.

Step 0: load the raw data, load the age 9 features, extract age 9 data
```{r, include=FALSE}
library(data.table)
library(stringr)
library(dmm)
library(Hmisc)
library(mice)

load("~/GitHub/Spr2017-proj5-grp3/data/background.RData")
source("~/GitHub/Spr2017-proj5-grp3/lib/helper_data.R")
#raw=read.csv("~/Documents/FFChallenge/background.csv",header=TRUE)

features<-colnames(background)

#create codebook
codebooks<-c("child","mom","dad","teacher")
data.info<-vector()

for (i in codebooks){
feat.table<-read.csv(paste0("~/GitHub/Spr2017-proj5-grp3/data/codebook/ff_",i,"_cb9.csv"),header=FALSE)
feat.table<-feat.table[,-1]
feat.table<-feat.table[-1,]
feat.table<-cbind(rep(i,nrow(feat.table)),feat.table)
data.info<-rbind(data.info,feat.table)
}

colnames(data.info)<-c("class","code","description")
data.info=as.data.frame(data.info)
featnum<-nrow(data.info)

extract.feature<-features %in% data.info$code  
sum(extract.feature)


extract.data<-background[,extract.feature]
extract.data<-cbind(challengeID=background[,1],extract.data)

write.csv(extract.data,file="~/GitHub/Spr2017-proj5-grp3/data/extract_data.csv")
save(data.info, file="data_info.RData")
```


Step 1: clean data
```{r}
#remove columns with missing values more than 80%
extract.data<-read.csv("~/GitHub/Spr2017-proj5-grp3/data/extract_data.csv")
ED<-divide.data(extract.data)
ED.categorical=ED[[1]]
ED.continuous=ED[[2]]

categorical=colnames(ED.categorical)

ED.factor=clean.factor(ED.continuous)

ED.continuous=ED.continuous[,!colnames(ED.continuous) %in% colnames(ED.factor)]
ED.continuous=clean.continuous(ED.continuous)

categorical=c(categorical,colnames(ED.factor[,grep("*isna",colnames(ED.factor))]),colnames(ED.continuous[,grep("*isna",colnames(ED.continuous))]))
#combine the data

ED.final<-cbind(ED.continuous,ED.categorical,ED.factor)

ED.final=as.data.frame(ED.final)
```



Step 2: solving missing data problem
```{r}

final.mis<-ED.final[,which(unlist(lapply(ED.final, function(x) anyNA(x))))]
imputed_Data <- mice(final.mis, m=5, maxit = 50, method = 'pmm', seed = 500)

completeData=list()

for (i in 1:5){
  completeData[[i]]<-cbind.data.frame(challengeID=ED.continuous[,1],complete(imputed_Data,i),ED.categorical)
  write.csv(completeData[[i]],file=paste0("~/GitHub/Spr2017-proj5-grp3/data/imputed",i,".csv"),row.names = FALSE)
}

save(categorical, file="categorical.RData")

```


Step 2: Combine features with labels
```{r}



```


```{r}

Bdf=read.csv("../data/features.csv")
Bcodes=Bdf$Codes
data.filtered= data.train[,Bcodes]

```


```{r}
library(e1071)
library(tree)
library(caret)
library(rpart)


#set.seed (1)
i.train = sample(1:nrow(data.filtered), nrow(data.filtered)*0.9)
dtrain=data.filtered[i.train,]
dtest=data.filtered[-i.train,]
ltrain=label$gpa[i.train]
ltest=label$gpa[-i.train]

dt=cbind(ltrain,dtrain)
dt=as.data.frame(dt)

tree.ff=rpart(ltrain~.,dt,method="anova")
min.xerror <- tree.ff$cptable[which.min(tree.ff$cptable[,"xerror"]),"CP"]
min.xerror #0.01629374
best.tree=prune(tree.ff,cp = min.xerror) 
tree.predict=predict(tree.ff,newdata = dtest)

error <- mean((tree.predict-ltest)^2)

cbind(tree.predict,ltest)
```


Random Forest
```{r}
source("~/GitHub/spr2017-proj3-group7/lib/train.R")

model.best<-Train(data.filtered,factor(label.train$gpa))
model.best$errors
```

