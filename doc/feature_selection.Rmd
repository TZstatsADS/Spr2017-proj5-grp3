---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

read in data, create a table for later use. 
```{r}
codebooks<-c("child","mom","dad","teacher")
data.info<-vector()

for (i in codebooks){
feat.table<-read.csv(paste0("../data/ff_",i,"_cb9.csv"),header=FALSE)
feat.table<-feat.table[,-1]
feat.table<-feat.table[-1,]
feat.table<-cbind(rep(i,nrow(feat.table)),feat.table)
data.info<-rbind(data.info,feat.table)
}

colnames(data.info)<-c("class","code","description")
data.info=as.data.frame(data.info)
  
rm(codebooks,i,feat.table)
```


preprocess x and y. 
```{r}

# These csv files are from main_yg.Rmd. testing_data.csv = label.train, and training_data.csv = data.train. 
y = read.csv("../data/testing_data.csv", as.is = T, header = T)
x = read.csv("../data/training_data.csv", as.is = T, header = T)
x$challengeID=NULL

# change -9 -6 -3 to NA
# deal with NA again

# knn model 
# adaboost and xgboost?
# boruta documentation: how to handle NA
# maybe try topic modeling on the questions



x[x == ""] <- NA
x = x[ , colSums(is.na(x)) == 0]

nums <- sapply(x, is.numeric)
x = x[ , nums]
cc = complete.cases(x)
x <- x[cc,]
y = y[cc,]

```

# deal with NA

```{r}
less_na_x = read.csv("../data/less_than_50%_NA.csv")
less_na_y = read.csv("../data/train.csv")
less_na_y = na.omit(less_na_y[, 1:2])
less_na_x = less_na_x[less_na_x$challengeID %in% less_na_y$challengeID, ]
less_na_y = less_na_y[less_na_y$challengeID %in% less_na_x$challengeID, ]
nums <- sapply(less_na_x, is.numeric)
less_na_x = less_na_x[ , nums]


library(Hmisc)

for(i in 3:ncol(less_na_x))
{
  less_na_x[,i] = impute(less_na_x[,i], fun = median)  
}

x = less_na_x[, 3:ncol(less_na_x)]
y = less_na_y

```


Boruta
```{r}
library(Boruta)
model = Boruta(x, y$gpa, maxRuns = 3000)
results = as.data.frame(model$finalDecision)
which(results!="Rejected")
Bcodes = rownames(results)[which(results!="Rejected")]

```


What are the descriptions of the features (Boruta)?
```{r}
des = data.frame()
score = data.frame()
for (i in 1:length(Bcodes))
{
  if(Bcodes[i] %in% data.info$code)
  {
    des = rbind(des, as.data.frame(data.info$description[data.info$code==Bcodes[i]]))
    score = rbind(score, as.data.frame(imp$meanImp[which(rownames(imp)==Bcodes[i])]))

  }
}
decision = as.data.frame(model$finalDecision[model$finalDecision!="Rejected"])

Bdf = cbind(Bcodes, des, decision, score)
colnames(Bdf) = c("Codes", "Description", "Decision", "Importance Score")
write.csv(Bdf, "../data/codes_description_importance_less_na.csv")
```


RF.
```{r}
library(randomForest)
rf = randomForest(x, y$gpa)
imp = as.data.frame(importance(rf))
RFcodes = rownames(imp)[imp$IncNodePurity>0.8]

des = data.frame()
for (i in 1:length(RFcodes))
{
  if(RFcodes[i] %in% data.info$code)
  {
    des = rbind(des, as.data.frame(data.info$description[data.info$code==RFcodes[i]]))
  }
}
scores = imp$IncNodePurity[imp$IncNodePurity>0.8]
RFdf = cbind(RFcodes,des,scores)
write.csv(RFdf, "../data/randomForest1.csv")

```


###################### below does not work. Trust me. ###############################



Does not work.

Finding overlap
```{r}
Odf = data.frame()
for (i in 1:length(RFcodes))
{
  if(RFcodes[i] %in% Bdf$Codes)
  {
    Odf = rbind(Odf, as.data.frame(data.info$description[data.info$code==RFcodes[i]]))
  }
}
Odf$Codes = RFcodes[RFcodes %in% RFcodes]



```



RFE. Takes over 24 hours.
```{r}
library(caret)
library(randomForest)
set.seed(123)
control <- rfeControl(functions=rfFuncs, method="cv", number=10)

ptm = proc.time()
rfe.train <- rfe(x, y$gpa, sizes=seq(1:ncol(x)), rfeControl=control)
ptm = proc.time() - ptm

```

